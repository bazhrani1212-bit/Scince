<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</title>

  <style>
    body{
      box-sizing:border-box;font-family:'Segoe UI',Tahoma,Arial,sans-serif;background:#f0f4f8;
      margin:0;padding:0;min-height:100vh
    }
    *,*::before,*::after{box-sizing:border-box}
    .main-wrapper{
      min-height:100vh;width:100%;display:flex;align-items:flex-start;justify-content:center;
      padding:10px;overflow:auto
    }
    .content-box{
      max-width:450px;width:100%;background:#fff;padding:20px;border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.1);text-align:right;margin:10px 0
    }
    .main-title{
      text-align:center;color:#fff;margin:0 0 20px;background:linear-gradient(135deg,#1a5f3f 0%,#2d8659 50%,#1a5f3f 100%);
      padding:15px;border-radius:15px;box-shadow:0 5px 20px rgba(26,95,63,.4);
      animation:titlePulse 2.5s ease-in-out infinite;border:3px solid #f4d03f;font-size:18px;font-weight:700;line-height:1.4
    }
    @keyframes titlePulse{
      0%,100%{transform:scale(1);box-shadow:0 5px 20px rgba(26,95,63,.4)}
      50%{transform:scale(1.02);box-shadow:0 8px 30px rgba(26,95,63,.6)}
    }
    .form-label{font-weight:700;margin-top:12px;margin-bottom:6px;display:block;color:#2d3748;font-size:14px}
    .form-input,.form-select{
      width:100%;padding:10px;margin-top:3px;border-radius:10px;border:2px solid #e2e8f0;
      font-size:14px;transition:border-color .3s;font-family:'Segoe UI',Tahoma,Arial,sans-serif
    }
    .form-input:focus,.form-select:focus{outline:none;border-color:#3b82f6}
    .primary-button{
      width:100%;margin-top:15px;padding:12px;background:#3b82f6;color:#fff;border:none;border-radius:12px;
      font-size:15px;cursor:pointer;font-weight:700;transition:background .3s,transform .1s
    }
    .primary-button:hover{background:#2563eb;transform:translateY(-2px)}
    .primary-button:active{transform:translateY(0)}
    .primary-button:disabled{background:#93c5fd;cursor:not-allowed;transform:none}
    .green-button{
      width:100%;margin-top:15px;padding:12px;background:#10b981;color:#fff;border:none;border-radius:12px;
      font-size:15px;cursor:pointer;font-weight:700;transition:background .3s,transform .1s
    }
    .green-button:hover{background:#059669;transform:translateY(-2px)}
    .green-button:active{transform:translateY(0)}
    .message-box{
      margin-top:12px;font-size:14px;text-align:center;font-weight:500;padding:10px;border-radius:8px;min-height:20px
    }
    .message-success{color:#059669;background:#d1fae5}
    .message-error{color:#dc2626;background:#fee2e2}

    .statistics-box{
      margin-top:20px;padding:15px;background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);
      border-radius:15px;text-align:center;border:2px solid #93c5fd;box-shadow:0 4px 15px rgba(59,130,246,.1)
    }
    .statistics-title{font-size:15px;color:#1e40af;font-weight:700;margin-bottom:10px}
    .statistics-content{font-size:13px;color:#374151;line-height:1.8}
    .statistics-row{margin-top:6px}
    .remaining-info{margin-top:8px;font-size:12px;color:#6b7280;font-weight:400}

    .limit-warning{
      margin-top:15px;padding:12px;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;text-align:center;
      color:#92400e;font-size:13px;font-weight:700;display:none;animation:warningShake .5s ease-in-out
    }
    .limit-warning.visible{display:block}
    @keyframes warningShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

    .modal-background{
      display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);
      z-index:1000;overflow:auto;padding:20px
    }
    .modal-background.active{display:flex;align-items:flex-start;justify-content:center}
    .modal-box{
      background:#fff;margin:20px auto;padding:0;max-width:95%;width:1200px;border-radius:15px;
      box-shadow:0 15px 50px rgba(0,0,0,.4);position:relative
    }
    .modal-top{
      background:linear-gradient(135deg,#1e40af 0%,#3b82f6 100%);color:#fff;padding:25px;border-radius:15px 15px 0 0;
      text-align:center;position:relative
    }
    .modal-top h2{color:#fff;margin:0 0 12px 0;font-size:24px;font-weight:700}
    .modal-close{
      position:absolute;left:20px;top:20px;background:rgba(255,255,255,.25);color:#fff;border:none;width:40px;height:40px;
      border-radius:50%;cursor:pointer;font-size:24px;font-weight:700;transition:background .3s
    }
    .modal-close:hover{background:rgba(255,255,255,.4)}
    .modal-statistics{font-size:15px;margin-top:8px;line-height:1.6}
    .modal-content{padding:25px;max-height:70vh;overflow-y:auto}

    .table-container{overflow-x:auto;border-radius:10px;border:1px solid #e5e7eb}
    .visitors-table{width:100%;border-collapse:collapse;min-width:1000px}
    .visitors-table th{
      background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;padding:15px;text-align:right;font-weight:700;
      position:sticky;top:0;z-index:10;font-size:14px
    }
    .visitors-table td{padding:12px 15px;border-bottom:1px solid #e5e7eb;text-align:right;font-size:14px}
    .visitors-table tbody tr:hover{background:#f9fafb}
    .visitors-table tbody tr:last-child td{border-bottom:none}

    .badge{display:inline-block;padding:5px 12px;border-radius:6px;font-size:13px;font-weight:700}
    .badge-primary{background:#dbeafe;color:#1e40af}
    .badge-middle{background:#d1fae5;color:#065f46}
    .badge-high{background:#fce7f3;color:#9f1239}
    .badge-enrichment{background:#ede9fe;color:#6b21a8}
    .badge-none{background:#f3f4f6;color:#6b7280}

    .empty-message{text-align:center;padding:50px;color:#9ca3af;font-size:16px}

    .team-section{
      margin-top:20px;padding:12px;background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);
      border-radius:15px;border:2px solid #f59e0b
    }
    .team-header{text-align:center;font-size:10px;color:#92400e;margin-bottom:8px;line-height:1.5;font-weight:700}
    .team-columns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .team-column{background:rgba(255,255,255,.6);padding:6px;border-radius:8px}
    .team-member{font-size:8px;color:#374151;padding:2px 0;border-bottom:1px solid rgba(0,0,0,.05);line-height:1.4}
    .team-member:last-child{border-bottom:none}

    @media (max-width:768px){
      .main-wrapper{padding:8px}
      .content-box{padding:12px;margin:5px 0}
      .main-title{font-size:14px;padding:10px;margin-bottom:15px}
      .form-label{font-size:12px;margin-top:10px;margin-bottom:4px}
      .form-input,.form-select{padding:8px;font-size:13px}
      .primary-button,.green-button{padding:10px;font-size:14px;margin-top:10px}
      .statistics-box{padding:12px;margin-top:15px}
      .statistics-title{font-size:13px}
      .statistics-content{font-size:11px}
      .team-section{padding:10px;margin-top:15px}
      .team-header{font-size:9px}
      .team-columns{grid-template-columns:1fr;gap:6px}
      .team-member{font-size:8px}
      .modal-top h2{font-size:18px}
      .modal-statistics{font-size:12px}
    }
  </style>
</head>

<body>
  <div class="main-wrapper">
    <div class="content-box">
      <h1 class="main-title" id="mainTitle">ğŸ® Ø¨ÙˆØ§Ø¨Ø© Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ ğŸ®</h1>

      <label class="form-label" for="studentName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</label>
      <input class="form-input" id="studentName" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©" autocomplete="name" />

      <label class="form-label" for="educationStage">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</label>
      <select class="form-select" id="educationStage">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
        <option value="primary">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
        <option value="middle">Ù…ØªÙˆØ³Ø·</option>
        <option value="high">Ø«Ø§Ù†ÙˆÙŠ</option>
      </select>

      <label class="form-label" for="studentGrade">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
      <input class="form-input" id="studentGrade" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" />

      <label class="form-label" for="schoolName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
      <input class="form-input" id="schoolName" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" />

      <label class="form-label" for="studyTerm">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
      <select class="form-select" id="studyTerm">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</option>
        <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£ÙˆÙ„</option>
        <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
      </select>

      <label class="form-label" for="selectedPlan">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <select class="form-select" id="selectedPlan">
        <option value="">Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</option>
        <option value="enrichment">Ø®Ø·Ø© Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©</option>
      </select>

      <button class="primary-button" id="enterButton">ğŸ® Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</button>
      <div id="messageBox" class="message-box"></div>

      <div class="statistics-box">
        <div class="statistics-title">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
        <div class="statistics-content">
          <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙˆØ§Ø± (Ø¹Ø§Ù…): <strong><span id="totalCount">â€”</span></strong></div>
          <div class="statistics-row">
            Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ: <strong><span id="primaryStageCount">â€”</span></strong> |
            Ù…ØªÙˆØ³Ø·: <strong><span id="middleStageCount">â€”</span></strong> |
            Ø«Ø§Ù†ÙˆÙŠ: <strong><span id="highStageCount">â€”</span></strong>
          </div>
          <div class="statistics-row">
            Ø®Ø·Ø· Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©: <strong><span id="enrichmentPlansCount">â€”</span></strong> |
            Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©: <strong><span id="noPlanCount">â€”</span></strong>
          </div>
          <div class="remaining-info">
            Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <strong><span id="slotsRemaining">â€”</span></strong> Ù…Ù† 999
          </div>
        </div>
      </div>

      <div id="capacityWarning" class="limit-warning">
        âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰! Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ 999 Ø³Ø¬Ù„
      </div>

      <button class="green-button" id="showLogBtn">ğŸ“‹ Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„ÙƒØ§Ù…Ù„</button>

      <div class="team-section">
        <div class="team-header">
          Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…Ø© / Ø¨Ø¯Ø±ÙŠØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ<br />
          Ù…Ù† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø© ÙˆØ§Ù„Ø«Ù„Ø§Ø«ÙˆÙ† Ø¨Ø®Ù…ÙŠØ³ Ù…Ø´ÙŠØ·<br />
          Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„
        </div>
        <div class="team-columns">
          <div class="team-column">
            <div class="team-member">Ø¨Ø¯Ø±ÙŠØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ - Ø®Ù…ÙŠØ³ Ù…Ø´ÙŠØ·</div>
            <div class="team-member">ÙŠØ³Ø±Ù‰ Ø§Ù„Ø£Ø³Ù…Ø±ÙŠ - Ø³Ø±Ø§Ø© Ø¹Ø¨ÙŠØ¯Ø©</div>
            <div class="team-member">Ù‡Ø¯Ù‰ Ø§Ù„Ø­Ø±Ø¨ÙŠ - Ø§Ù„Ø®Ø±Ø¬</div>
            <div class="team-member">Ù‡Ø¯Ù‰ Ø§Ù„Ù…Ø¸ÙŠØ¨Ø±ÙŠ - Ø­ÙØ± Ø§Ù„Ø¨Ø§Ø·Ù†</div>
            <div class="team-member">Ù†Ù‡Ù„Ø© Ø¹Ù„Ø§Ù… - Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</div>
            <div class="team-member">Ø³Ø§Ù…ÙŠØ© Ø®Ø±Ù…ÙŠ - Ø¬Ø§Ø²Ø§Ù†</div>
            <div class="team-member">ÙˆØ¦Ø§Ù… Ø§Ù„ÙƒÙˆØ± - Ø¬Ø§Ø²Ø§Ù†</div>
            <div class="team-member">ØºÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø­Ø±Ø¨ÙŠ - Ø¨Ø±ÙŠØ¯Ù‡</div>
            <div class="team-member">Ù†ÙˆÙ Ù…Ø­Ù…Ø¯ - Ø§Ù„Ø±ÙŠØ§Ø¶</div>
            <div class="team-member">Ø§ÙŠÙ…Ø§Ù† Ø§Ù„Ù†ÙÙŠØ³Ø© - Ø§Ù„Ø®Ø±Ø¬</div>
            <div class="team-member">Ø­ÙØ¸ÙŠØ© Ø§Ù„Ø­Ø§Ø²Ù…ÙŠ - ØµØ¨ÙŠØ§</div>
            <div class="team-member">Ù†Ø¯Ù‰ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ - Ø§Ù„Ø±ÙŠØ§Ø¶</div>
            <div class="team-member">Ø®Ù„ÙˆØ¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ - Ø§Ù„Ø¨Ø§Ø­Ø©</div>
            <div class="team-member">Ù†Ø¯Ù‰ Ù…Ø±ÙˆØ­ÙŠ - Ø¬Ø§Ø²Ø§Ù†</div>
          </div>
          <div class="team-column">
            <div class="team-member">Ø³Ø§Ø±Ø© Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ - Ø§Ù„Ù…Ø²Ø§Ø­Ù…ÙŠØ©</div>
            <div class="team-member">Ø¹Ø§Ø¦Ø´Ø© Ø§Ù„ÙƒØ¹Ø¨ÙŠ - Ù…ÙƒØ©</div>
            <div class="team-member">Ù†Ø¬ÙˆØ¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ - Ø£Ø¨Ù‡Ø§</div>
            <div class="team-member">ØµÙÙŠØ© Ø¬Ø¨Ø±ÙŠÙ† - Ø§Ù„Ø±ÙŠØ§Ø¶</div>
            <div class="team-member">Ø®Ù„ÙˆØ¯ Ø§Ù„Ø¨Ø±Ø§Ø² - Ø§Ù„Ø£Ø­Ø³Ø§Ø¡</div>
            <div class="team-member">Ø¹Ø¨ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ - Ø§Ù„Ø±ÙŠØ§Ø¶</div>
            <div class="team-member">ÙØ§Ø·Ù…Ø© Ø®ÙˆØ§Ø¬ÙŠ - ØµØ¨ÙŠØ§</div>
            <div class="team-member">Ù…Ù‡Ø§ Ø§Ù„Ø­Ù…Ø§Ø¯ - Ø§Ù„Ø±ÙŠØ§Ø¶</div>
            <div class="team-member">Ø¨ÙŠÙ†Ù‡ Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ - Ø§Ù„Ø®Ø±Ø¬</div>
            <div class="team-member">Ù‡Ø¯Ù‰ Ø§Ù„Ø´Ù‡Ø±ÙŠ - Ù…Ø­Ø§ÙŠÙ„ Ø¹Ø³ÙŠØ±</div>
            <div class="team-member">ØªÙ‡Ø§Ù†ÙŠ Ø§Ù„Ù…Ø¸ÙŠØ¨Ø±ÙŠ - Ø­ÙØ± Ø§Ù„Ø¨Ø§Ø·Ù†</div>
            <div class="team-member">Ù†ÙˆØ±Ø© Ø´ÙˆÙŠÙ…ÙŠ - Ø§Ù„Ø±ÙŠØ§Ø¶</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal -->
  <div id="visitorsLogModal" class="modal-background">
    <div class="modal-box">
      <div class="modal-top">
        <button class="modal-close" id="closeModalBtn">Ã—</button>
        <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø²ÙˆØ§Ø± Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</h2>
        <div id="modalStatisticsText" class="modal-statistics"></div>
      </div>
      <div class="modal-content">
        <div class="table-container">
          <table class="visitors-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th>
                <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                <th>Ø§Ù„ØµÙ</th>
                <th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
                <th>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø©</th>
                <th>Ø§Ù„ÙŠÙˆÙ…</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ÙˆÙ‚Øª</th>
              </tr>
            </thead>
            <tbody id="visitorsTableContent">
              <tr><td colspan="10" class="empty-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   1) Ø¹Ø¯Ù‘Ù„ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙ‚Ø·
========================= */
const GOOGLE_APPS_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbzpP8ec9V7OPAVWSe-jXSqlMhtCHMNl7AbaxTsnaNga6c6BJmHeUXeIZFEcyLyEywDq/exec";

/* =========================
   2) Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙØ­Ø§Øª (ÙƒÙ…Ø§ Ø¹Ù†Ø¯Ùƒ)
========================= */
const GAMES_BANK_URLS = {
  primary: "https://36primery-school.my.canva.site/dag7eshommq",
  middle:  "https://36primery-school.my.canva.site/dag7e0tn1a4",
  high:    "https://36primery-school.my.canva.site/dag7fdv41f4"
};
const ENRICHMENT_PLANS_URL = "https://36primery-school.my.canva.site/dag8kgyzgkq";

/* ========================= */
const MAXIMUM_RECORDS = 999;
const WARNING_THRESHOLD = 950;

let lastStats = null;     // Ø¢Ø®Ø± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¬Ù„Ø¨Ù†Ø§Ù‡Ø§
let lastList  = [];       // Ø¢Ø®Ø± Ø³Ø¬Ù„ Ø²ÙˆØ§Ø± Ø¬Ù„Ø¨Ù†Ø§Ù‡

/* ===== Ø£Ø¯ÙˆØ§Øª ===== */
function $(id){ return document.getElementById(id); }
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function stageLabel(stage){
  return stage === "primary" ? "Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" : stage === "middle" ? "Ù…ØªÙˆØ³Ø·" : "Ø«Ø§Ù†ÙˆÙŠ";
}
function stageBadge(stage){
  return stage === "primary" ? "badge-primary" : stage === "middle" ? "badge-middle" : "badge-high";
}

/* =========================
   3) Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª
   ÙŠØªØ·Ù„Ø¨ Apps Script ÙŠØ¯Ø¹Ù… action=stats
========================= */
async function fetchStats(){
  try{
    const res = await fetch(GOOGLE_APPS_SCRIPT_URL + "?action=stats", { method:"GET" });
    const data = await res.json();
    lastStats = data;
    renderStats(data);
    return data;
  }catch(e){
    // Ø¥Ø°Ø§ ÙØ´Ù„ (CORS Ø£Ùˆ ØºÙŠØ±Ù‡) Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹
    renderStats(null, true);
    return null;
  }
}

function renderStats(data, failed=false){
  if(failed || !data || !data.ok){
    $("totalCount").textContent = "â€”";
    $("primaryStageCount").textContent = "â€”";
    $("middleStageCount").textContent = "â€”";
    $("highStageCount").textContent = "â€”";
    $("enrichmentPlansCount").textContent = "â€”";
    $("noPlanCount").textContent = "â€”";
    $("slotsRemaining").textContent = "â€”";
    $("capacityWarning").classList.remove("visible");
    return;
  }

  $("totalCount").textContent = data.totalVisitorsEver ?? 0;
  $("primaryStageCount").textContent = data.primary ?? 0;
  $("middleStageCount").textContent = data.middle ?? 0;
  $("highStageCount").textContent = data.high ?? 0;
  $("enrichmentPlansCount").textContent = data.enrichment ?? 0;
  $("noPlanCount").textContent = data.noPlan ?? 0;

  const recordsCount = data.recordsCount ?? 0;
  const remaining = Math.max(0, MAXIMUM_RECORDS - recordsCount);
  $("slotsRemaining").textContent = remaining;

  if(recordsCount >= WARNING_THRESHOLD) $("capacityWarning").classList.add("visible");
  else $("capacityWarning").classList.remove("visible");
}

/* =========================
   4) ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© (action=visit)
========================= */
async function logVisit(visitObj){
  // Ù†Ø³ØªØ®Ø¯Ù… GET Ù„ØªÙØ§Ø¯ÙŠ preflight
  const qs = new URLSearchParams({
    action: "visit",
    name: visitObj.name,
    stage: visitObj.stage,
    grade: visitObj.grade,
    school: visitObj.school,
    term: visitObj.term,
    planType: visitObj.planType || "",
    day: visitObj.day,
    date: visitObj.date,
    time: visitObj.time,
    timestamp: String(visitObj.timestamp),
    ua: navigator.userAgent || "",
    ref: document.referrer || ""
  });

  // Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø±Ø¯ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡ Ø¨Ø³Ø¨Ø¨ CORSØŒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØªÙ…
  await fetch(GOOGLE_APPS_SCRIPT_URL + "?" + qs.toString(), { method:"GET" });
}

/* =========================
   5) Ø§Ù„Ø¯Ø®ÙˆÙ„
========================= */
async function enterGamesBank(){
  const studentName = $("studentName").value.trim();
  const educationStage = $("educationStage").value;
  const studentGrade = $("studentGrade").value.trim();
  const schoolName = $("schoolName").value.trim();
  const studyTerm = $("studyTerm").value;
  const selectedPlan = $("selectedPlan").value;

  const messageBox = $("messageBox");
  const enterBtn = $("enterButton");

  if(!studentName || !educationStage || !studentGrade || !schoolName || !studyTerm){
    messageBox.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©";
    messageBox.className = "message-box message-error";
    return;
  }

  const targetURL = (selectedPlan === "enrichment")
    ? ENRICHMENT_PLANS_URL
    : GAMES_BANK_URLS[educationStage];

  // ÙØªØ­ Ù†Ø§ÙØ°Ø© ÙÙˆØ±Ù‹Ø§ (Ù„ØªÙØ§Ø¯ÙŠ Ø­Ø¸Ø± iOS)
  const win = window.open("about:blank", "_blank");

  enterBtn.disabled = true;
  messageBox.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
  messageBox.className = "message-box";

  const now = new Date();
  const arabicDays = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
  const dayName = arabicDays[now.getDay()];
  const dateString = now.toLocaleDateString('ar-SA-u-ca-gregory');
  const timeString = now.toLocaleTimeString('ar-SA', { hour:'2-digit', minute:'2-digit', second:'2-digit' });

  const visitObj = {
    name: studentName,
    stage: educationStage,
    grade: studentGrade,
    school: schoolName,
    term: studyTerm,
    planType: selectedPlan || "",
    day: dayName,
    date: dateString,
    time: timeString,
    timestamp: now.getTime()
  };

  try{
    await logVisit(visitObj);
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    await fetchStats();

    messageBox.textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
    messageBox.className = "message-box message-success";
  }catch(e){
    messageBox.textContent = "âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· (ØªØ¹Ø°Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ø­ÙØ¸)";
    messageBox.className = "message-box message-success";
  }

  // ÙØªØ­ Ø§Ù„ÙˆØ¬Ù‡Ø©
  if(win) win.location.href = targetURL;

  // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
  setTimeout(()=>{
    $("studentName").value = "";
    $("educationStage").value = "";
    $("studentGrade").value = "";
    $("schoolName").value = "";
    $("studyTerm").value = "";
    $("selectedPlan").value = "";
    messageBox.textContent = "";
    messageBox.className = "message-box";
    enterBtn.disabled = false;
  }, 2000);
}

/* =========================
   6) Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø± (action=list)
========================= */
async function fetchVisitorsList(limit=999){
  const res = await fetch(GOOGLE_APPS_SCRIPT_URL + "?action=list&limit=" + encodeURIComponent(limit), { method:"GET" });
  const data = await res.json();
  if(data && data.ok && Array.isArray(data.items)){
    lastList = data.items;
    return data.items;
  }
  return [];
}

async function showVisitorsLog(){
  const modal = $("visitorsLogModal");
  const tableBody = $("visitorsTableContent");
  const modalStats = $("modalStatisticsText");

  modal.classList.add("active");
  document.body.style.overflow = "hidden";
  tableBody.innerHTML = '<tr><td colspan="10" class="empty-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„â€¦</td></tr>';

  try{
    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    if(!lastStats) await fetchStats();
    const items = await fetchVisitorsList(999);

    const s = lastStats && lastStats.ok ? lastStats : null;
    const recordsCount = s?.recordsCount ?? items.length ?? 0;
    const remaining = Math.max(0, MAXIMUM_RECORDS - recordsCount);

    modalStats.innerHTML = s ? `
      Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙˆØ§Ø± Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: <strong>${s.totalVisitorsEver ?? 0}</strong> |
      Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>${recordsCount}</strong><br>
      Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ: <strong>${s.primary ?? 0}</strong> |
      Ù…ØªÙˆØ³Ø·: <strong>${s.middle ?? 0}</strong> |
      Ø«Ø§Ù†ÙˆÙŠ: <strong>${s.high ?? 0}</strong><br>
      Ø®Ø·Ø· Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©: <strong>${s.enrichment ?? 0}</strong> |
      Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©: <strong>${s.noPlan ?? 0}</strong><br>
      Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <strong>${remaining}</strong> Ù…Ù† 999
    ` : `ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª â€“ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ ÙÙ‚Ø· Ø¥Ù† ØªÙˆÙØ±.`;

    if(!items.length){
      tableBody.innerHTML = '<tr><td colspan="10" class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
      return;
    }

    tableBody.innerHTML = items.map((v, idx)=>{
      const stage = v.stage || "";
      const planType = v.planType || "";
      const planLabel = planType === "enrichment" ? "Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©" : "Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©";
      const planBadge = planType === "enrichment" ? "badge-enrichment" : "badge-none";

      return `
        <tr>
          <td>${items.length - idx}</td>
          <td>${escapeHtml(v.name)}</td>
          <td><span class="badge ${stageBadge(stage)}">${stageLabel(stage)}</span></td>
          <td>${escapeHtml(v.grade)}</td>
          <td>${escapeHtml(v.school || "-")}</td>
          <td>${escapeHtml(v.term)}</td>
          <td><span class="badge ${planBadge}">${planLabel}</span></td>
          <td>${escapeHtml(v.day)}</td>
          <td>${escapeHtml(v.date)}</td>
          <td>${escapeHtml(v.time)}</td>
        </tr>
      `;
    }).join("");
  }catch(e){
    tableBody.innerHTML = '<tr><td colspan="10" class="empty-message">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ (ØªØ­Ù‚Ù‚ Ù…Ù† Apps Script)</td></tr>';
    modalStats.innerHTML = `ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª/Ø§Ù„Ø³Ø¬Ù„.`;
  }
}

function hideVisitorsLog(){
  $("visitorsLogModal").classList.remove("active");
  document.body.style.overflow = "auto";
}

/* =========================
   7) ØªØ´ØºÙŠÙ„ ÙˆØ±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
========================= */
$("enterButton").addEventListener("click", enterGamesBank);
$("showLogBtn").addEventListener("click", showVisitorsLog);
$("closeModalBtn").addEventListener("click", hideVisitorsLog);
$("visitorsLogModal").addEventListener("click", (e)=>{
  if(e.target && e.target.id === "visitorsLogModal") hideVisitorsLog();
});

// Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„: Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
fetchStats();
</script>
</body>
</html>
